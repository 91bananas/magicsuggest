/**
 * All auto suggestion boxes are fucked up or badly written.
 * This is an attempt to create something that doesn't suck...
 *
 * Requires: jQuery and the Class class for OOP.
 *
 * Author: Nicolas Bize
 * Date: Feb. 8th 2013
 * Version: 1.0
 * Licence: MagicSuggest is licenced under MIT licence (http://www.opensource.org/licenses/mit-license.php)
 */
var MagicSuggest=Class.create({init:function(e){this.allowFreeEntries=e.allowFreeEntries!==undefined?e.allowFreeEntries:true;this.preselectSingleSuggestion=e.preselectSingleSuggestion!==undefined?e.preselectSingleSuggestion:true;this.cls=e.cls||"";this.data=e.data!==undefined?e.data:null;this.disabled=!!e.disabled;this.displayField=e.displayField||"name";this.editable=e.editable!==undefined?e.editable:true;this.emptyText=e.emptyText||(this.editable===true?"Type or click here":"Click here");this.emptyTextCls=e.emptyTextCls||"ms-empty-text";this.expanded=!!e.expanded;this.expandOnFocus=this.editable===false?true:!!e.expandOnFocus;this.hideTrigger=!!e.hideTrigger;this.highlight=e.highlight!==undefined?e.highlight:true;this.matchCase=!!e.matchCase;this.maxDropHeight=e.maxDropHeight||300;this.maxResults=e.maxResults||10;this.maxSelection=e.maxSelection||10;this.minChars=$.isNumeric(e.minChars)?e.minChars:typeof this.data==="string"&&this.data.indexOf(",")<0?2:0;this.renderTo=e.renderTo||null;this.selectionCls=e.selectionCls||"";if($.type(e.selectionPosition)==="string"){if(["right","bottom","inner"].indexOf(e.selectionPosition.toLowerCase())===-1){throw"selectionPosition is not valid. Only 'right', 'bottom' and 'inner' are accepted"}this.selectionPosition=e.selectionPosition.toLowerCase()}else{this.selectionPosition="inner"}this.selectionStacked=!!e.selectionStacked;if(this.selectionStacked===true&&this.selectionPosition!=="bottom"){this.selectionPosition="bottom"}if($.type(e.sortDir)==="string"){if(["asc","desc"].indexOf(e.sortDir.toLowerCase())===-1){throw"sortDir is not valid. Only 'asc' and 'desc' are accepted"}this.sortDir=e.sortDir.toLowerCase()}else{this.sortDir="asc"}this.sortOrder=e.sortOrder!==undefined?e.sortOrder:null;this.useTabKey=!!e.useTabKey;this.useZebraStyle=e.useZebraStyle!==undefined?e.useZebraStyle:true;this.valueField=e.valueField||"id";this.width=e.width||$(this.renderTo).width();this._events=["afterrender","beforerender","blur","collapse","expand","focus","onbeforeload","onkeydown","onkeydown","onkeyup","onload","ontriggerclick","selectionchange"];this._selection=[];if(this.renderTo!==null){this._doRender()}return this},addToSelection:function(e){if(this.maxSelection===false||this._selection.length<this.maxSelection){if(!$.isArray(e)){e=[e]}var t=this,n=false;$.each(e,function(e,r){if(t.getValue().indexOf(r[t.valueField])===-1){t._selection.push(r);n=true}});if(n===true){this._renderSelection();this.input.val("");$(this).trigger("selectionchange",[this,this.getSelectedItems()])}}},collapse:function(){if(this.expanded===true){this.combobox.detach();this.container.removeClass("ms-ctn-bootstrap-focus");this.expanded=false;$(this).trigger("collapse",[this])}},disable:function(){this.container.addClass("ms-ctn-disabled");this.disabled=true},enable:function(){this.container.removeClass("ms-ctn-disabled");this.disabled=false},expand:function(){if(!this.expanded&&this.input.val().length>=this.minChars){this._processSuggestions();this.combobox.appendTo(this.container);this.expanded=true;$(this).trigger("expand",[this])}},isDisabled:function(){return this.disabled},isRendered:function(){return this._rendered===true},getSelectedItems:function(){return this._selection},getValue:function(){var e=this;return $.map(this._selection,function(t){return t[e.valueField]})},removeFromSelection:function(e){if(!$.isArray(e)){e=[e]}var t=this,n=false;$.each(e,function(e,r){var i=t.getValue().indexOf(r[t.valueField]);if(i>-1){t._selection.splice(i,1);n=true}});if(n===true){this._renderSelection();$(this).trigger("selectionchange",[this,this.getSelectedItems()]);if(this.expanded){this._processSuggestions()}}},render:function(e){if(this.isRendered()===false){this.renderTo=e;this._doRender()}},setValue:function(e){},_doRender:function(){if(this.isRendered()===false){$(this).trigger("beforerender",[this]);this.container=$("<div/>",{id:"ms-ctn-"+$('div[id^="ms-ctn"]').length,"class":"ms-ctn "+this.cls+(this.disabled===true?" ms-ctn-disabled":"")+(this.editable===true?"":" ms-ctn-readonly"),style:"width: "+this.width+"px;"});this.container.focus($.proxy(this._onContainerFocus,this));this.container.blur($.proxy(this._onContainerBlur,this));this.container.keydown($.proxy(this._onHandleKeyDown,this));this.container.keyup($.proxy(this._onHandleKeyUp,this));this.input=$("<input/>",{id:"ms-input-"+$('input[id^="ms-input"]').length,type:"text","class":this.emptyTextCls+(this.editable===true?"":" ms-input-readonly"),value:this.emptyText,readonly:!this.editable,style:"width: "+(this.width-(this.hideTrigger?16:38))+"px;"});this.input.focus($.proxy(this._onInputFocus,this));if(this.hideTrigger===false){this.trigger=$("<div/>",{id:"ms-trigger-"+$('div[id^="ms-trigger"]').length,"class":"ms-trigger",html:'<div class="ms-trigger-ico"></div>'});this.trigger.click($.proxy(this._onTriggerClick,this));this.container.append(this.trigger)}this.combobox=$("<div/>",{id:"ms-res-ctn-"+$('div[id^="ms-res-ctn"]').length,"class":"ms-res-ctn",style:"width: "+this.width+"px; height: "+this.maxDropHeight+"px;"});this.selectionContainer=$("<div/>",{id:"ms-sel-ctn-"+$('div[id^="ms-sel-ctn"]').length,"class":"ms-sel-ctn"});this.selectionContainer.click($.proxy(this._onContainerFocus,this));if(this.selectionPosition==="inner"){this.selectionContainer.append(this.input)}else{this.container.append(this.input)}$(this.renderTo).replaceWith(this.container);switch(this.selectionPosition){case"bottom":this.selectionContainer.insertAfter(this.container);if(this.selectionStacked===true){this.selectionContainer.width(this.container.width());this.selectionContainer.addClass("ms-stacked")}break;case"right":this.selectionContainer.insertAfter(this.container);this.container.css("float","left");break;default:this.container.append(this.selectionContainer);break}this._rendered=true;$(this).trigger("afterrender",[this]);var e=this;$("body").click(function(t){if(e.container.has(t.target).length===0){e._onContainerBlur()}})}},_onContainerFocus:function(){this.input.focus()},_onInputFocus:function(){if(this.isDisabled()===false){this.container.addClass("ms-ctn-bootstrap-focus");if(this.input.val()===this.emptyText){this.input.removeClass(this.emptyTextCls);this.input.val("")}if(this.expandOnFocus===true&&this.input.val().length===0||this.input.val().length>this.minChars){this.expand()}$(this).trigger("focus",[this])}},_onContainerBlur:function(){if(!this.input.is(":focus")){this._forceBlur()}},_forceBlur:function(){this.container.removeClass("ms-ctn-bootstrap-focus");if(this.input.val()===""){this.input.addClass(this.emptyTextCls);this.input.val(this.emptyText)}this.collapse();$(this).trigger("blur",[this])},_onHandleKeyDown:function(e){var t=this.combobox.find(".ms-res-item-active:first"),n=this.input.val()!==this.emptyText?this.input.val():"";$(this).trigger("onkeydown",[this,e]);if(e.keyCode===9&&(this.useTabKey===false||this.useTabKey===true&&t.length===0&&this.input.val().length===0)){this._forceBlur();return}switch(e.keyCode){case 8:if(n.length===0&&this.getSelectedItems().length>0&&this.selectionPosition==="inner"){this._selection.pop();this._renderSelection();$(this).trigger("selectionchange",[this,this.getSelectedItems()]);this.input.focus();e.preventDefault()}break;case 9:e.preventDefault();break;case 40:e.preventDefault();this._moveSelectedRow("down");break;case 38:e.preventDefault();this._moveSelectedRow("up");break}},_onHandleKeyUp:function(e){var t=this.input.val()!==this.emptyText?this.input.val():"",n=this.input.val().length>0&&this.input.val()!==this.emptyText,r,i={},s=this;$(this).trigger("onkeyup",[this,e]);if(e.keyCode===9&&this.useTabKey===false||e.keyCode>13&&e.keyCode<32){return}switch(e.keyCode){case 40:case 38:e.preventDefault();break;case 13:case 9:e.preventDefault();if(this.expanded){r=this.combobox.find(".ms-res-item-active:first");if(r.length>0){r.click();return}}if(n===true&&this.allowFreeEntries===true){i[this.displayField]=i[this.valueField]=t;this.addToSelection(i);this.collapse();s.input.focus()}break;default:if(this.expanded===true){this._processSuggestions()}else if(t.length>=this.minChars&&this.expanded===false){this.expand()}break}},_onTriggerClick:function(){if(this.isDisabled()===false){$(this).trigger("ontriggerclick",[this]);if(this.expanded===true){this.collapse()}else{this.input.focus();this.expand()}}},_processSuggestions:function(){if(this.data!==null){if(typeof this.data==="string"&&this.data.indexOf(",")<0){$(this).trigger("onbeforeload",[this]);var e=this;$.ajax({type:"post",url:this.data,data:JSON.stringify({query:this.input.val()}),success:function(t){var n=JSON.parse(t);$(this).trigger("onload",[e,n]);e._displaySuggestions(e._sortAndTrim(n))},error:function(){throw"Could not reach server"}})}else if(typeof this.data==="string"&&this.data.indexOf(",")>-1){this._displaySuggestions(this._sortAndTrim(this._getEntriesFromStringArray(this.data.split(","))))}else{if(this.data.length>0&&typeof this.data[0]==="string"){this._displaySuggestions(this._sortAndTrim(this._getEntriesFromStringArray(this.data)))}else{this._displaySuggestions(this._sortAndTrim(this.data))}}}},_getEntriesFromStringArray:function(e){var t=[],n=this;$.each(e,function(e,r){var i={};i[n.displayField]=i[n.valueField]=r.trim();t.push(i)});return t},_sortAndTrim:function(e){var t=this,n=this.input.val()!==this.emptyText?this.input.val():"",r=[],i=[],s=this.getValue();if(n.length>0){$.each(e,function(e,i){var s=i[t.displayField];if(t.matchCase===true&&s.indexOf(n)>-1||t.matchCase===false&&s.toLowerCase().indexOf(n.toLowerCase())>-1){r.push(i)}})}else{r=e}$.each(r,function(e,n){if(s.indexOf(n[t.valueField])===-1){i.push(n)}});if(this.sortOrder!==null){i.sort(function(e,n){if(e[t.sortOrder]<n[t.sortOrder]){return t.sortDir==="asc"?-1:1}if(e[t.sortOrder]>n[t.sortOrder]){return t.sortDir==="asc"?1:-1}return 0})}if(this.maxResults!==false&&this.maxResults>0){i=i.slice(0,this.maxResults)}return i},_displaySuggestions:function(e){this.combobox.empty();var t=this,n=0;$.each(e,function(e,r){var i=$("<div/>",{"class":"ms-res-item "+(e%2===1&&t.useZebraStyle===true?"ms-res-odd":""),html:t.highlight===true?t._highlightSuggestion(r[t.displayField]):r[t.displayField]}).data("json",r);i.click($.proxy(t._onComboItemSelected,t));i.mouseover($.proxy(t._onComboItemMouseOver,t));t.combobox.append(i);n+=29});if(n<this.combobox.height()||n<this.maxDropHeight){this.combobox.height(n)}else if(n>=this.combobox.height()&&n>this.maxDropHeight){this.combobox.height(this.maxDropHeight)}if(e.length===1&&this.preselectSingleSuggestion===true){this.combobox.children().addClass("ms-res-item-active")}},_highlightSuggestion:function(e){var t=this.input.val()!==this.emptyText?this.input.val():"";if(t.length===0){return e}if(this.matchCase===true){e=e.replace(new RegExp("("+t+")","g"),"<em>$1</em>")}else{e=e.replace(new RegExp("("+t+")","gi"),"<em>$1</em>")}return e},_onComboItemMouseOver:function(e){this.combobox.children().removeClass("ms-res-item-active");$(e.currentTarget).addClass("ms-res-item-active")},_onComboItemSelected:function(e){var t=this;this.addToSelection($(e.currentTarget).data("json"));$(e.currentTarget).removeClass("ms-res-item-active");this.collapse();t.input.focus()},_renderSelection:function(){var e=this,t=0,n=0;if(this.selectionPosition==="inner"){this.input.detach()}this.selectionContainer.empty();$.each(this._selection,function(t,n){var r,i;r=$("<div/>",{"class":"ms-sel-item "+e.selectionCls,html:n[e.displayField]}).data("json",n);i=$("<span/>",{"class":"ms-close-btn"}).data("json",n).appendTo(r);i.click($.proxy(e._onRemoveFromSelection,e));e.selectionContainer.append(r)});if(this.selectionPosition==="inner"){this.selectionContainer.append(this.input);this.input.width(0);if(this.editable===true||this._selection.length===0){n=this.input.offset().left-this.selectionContainer.offset().left;t=this.container.width()-n-32-(this.hideTrigger===true?0:36);this.input.width(t<100?100:t)}this.container.height(this.selectionContainer.height())}},_onRemoveFromSelection:function(e){this.removeFromSelection($(e.currentTarget).data("json"))},_moveSelectedRow:function(e){if(!this.expanded){this.expand()}var t,n,r,i;t=this.combobox.find(".ms-res-item");if(e==="down"){n=t.eq(0)}else{n=t.filter(":last")}r=this.combobox.find(".ms-res-item-active:first");if(r.length>0){if(e==="down"){n=r.next();if(n.length===0){n=t.eq(0)}i=this.combobox.scrollTop();this.combobox.scrollTop(0);if(n[0].offsetTop+n.height()>this.combobox.height()){this.combobox.scrollTop(i+29)}}else{n=r.prev();if(n.length===0){n=t.filter(":last");this.combobox.scrollTop(29*t.length)}if(n[0].offsetTop<this.combobox.scrollTop()){this.combobox.scrollTop(this.combobox.scrollTop()-29)}}}t.removeClass("ms-res-item-active");n.addClass("ms-res-item-active")}})