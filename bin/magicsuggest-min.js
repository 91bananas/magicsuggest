/**
 * All auto suggestion boxes are fucked up or badly written.
 * This is an attempt to create something that doesn't suck...
 *
 * Requires: jQuery and the Class class for OOP.
 *
 * Author: Nicolas Bize
 * Date: Feb. 8th 2013
 * Version: 1.0
 * Licence: MagicSuggest is licenced under MIT licence (http://www.opensource.org/licenses/mit-license.php)
 */
var MagicSuggest=Class.create({init:function(a){if(this.allowFreeEntries=void 0!==a.allowFreeEntries?a.allowFreeEntries:!0,this.preselectSingleSuggestion=void 0!==a.preselectSingleSuggestion?a.preselectSingleSuggestion:!0,this.cls=a.cls||"",this.data=void 0!==a.data?a.data:null,this.disabled=!!a.disabled,this.displayField=a.displayField||"name",this.editable=void 0!==a.editable?a.editable:!0,this.emptyText=a.emptyText||(this.editable===!0?"Type or click here":"Click here"),this.emptyTextCls=a.emptyTextCls||"ms-empty-text",this.expanded=!!a.expanded,this.expandOnFocus=this.editable===!1?!0:!!a.expandOnFocus,this.hideTrigger=!!a.hideTrigger,this.highlight=void 0!==a.highlight?a.highlight:!0,this.matchCase=!!a.matchCase,this.maxDropHeight=a.maxDropHeight||300,this.maxResults=a.maxResults||10,this.maxSelection=a.maxSelection||10,this.minChars=$.isNumeric(a.minChars)?a.minChars:"string"==typeof this.data&&0>this.data.indexOf(",")?2:0,this.renderTo=a.renderTo||null,this.resultAsString=!!a.resultAsString,this.selectionCls=a.selectionCls||"","string"===$.type(a.selectionPosition)){if(-1===["right","bottom","inner"].indexOf(a.selectionPosition.toLowerCase()))throw"selectionPosition is not valid. Only 'right', 'bottom' and 'inner' are accepted";this.selectionPosition=a.selectionPosition.toLowerCase()}else this.selectionPosition="inner";if(this.selectionStacked=!!a.selectionStacked,this.selectionStacked===!0&&"bottom"!==this.selectionPosition&&(this.selectionPosition="bottom"),"string"===$.type(a.sortDir)){if(-1===["asc","desc"].indexOf(a.sortDir.toLowerCase()))throw"sortDir is not valid. Only 'asc' and 'desc' are accepted";this.sortDir=a.sortDir.toLowerCase()}else this.sortDir="asc";return this.sortOrder=void 0!==a.sortOrder?a.sortOrder:null,this.useTabKey=!!a.useTabKey,this.useCommaKey=void 0!==a.useCommaKey?a.useCommaKey:!0,this.useZebraStyle=void 0!==a.useZebraStyle?a.useZebraStyle:!0,this.value=void 0!==a.value?a.value:null,this.valueField=a.valueField||"id",this.width=a.width||$(this.renderTo).width(),this._events=["afterrender","beforerender","blur","collapse","expand","focus","onbeforeload","onkeydown","onkeydown","onkeyup","onload","ontriggerclick","selectionchange"],this._selection=[],null!==this.renderTo&&this._doRender(),this},addToSelection:function(a){if(this.maxSelection===!1||this._selection.length<this.maxSelection){$.isArray(a)||(a=[a]);var b=this,c=!1;$.each(a,function(a,d){-1===b.getValue().indexOf(d[b.valueField])&&(b._selection.push(d),c=!0)}),c===!0&&(this._renderSelection(this.resultAsString),this.input.val(""),$(this).trigger("selectionchange",[this,this.getSelectedItems()]))}},collapse:function(){this.expanded===!0&&(this.combobox.detach(),this.container.removeClass("ms-ctn-bootstrap-focus"),this.expanded=!1,$(this).trigger("collapse",[this]))},disable:function(){this.container.addClass("ms-ctn-disabled"),this.disabled=!0},enable:function(){this.container.removeClass("ms-ctn-disabled"),this.disabled=!1},expand:function(){!this.expanded&&this.input.val().length>=this.minChars&&(this._processSuggestions(),this.combobox.appendTo(this.container),this.expanded=!0,$(this).trigger("expand",[this]))},isDisabled:function(){return this.disabled},isRendered:function(){return this._rendered===!0},getSelectedItems:function(){return this._selection},getValue:function(){var a=this;return $.map(this._selection,function(b){return b[a.valueField]})},removeFromSelection:function(a){$.isArray(a)||(a=[a]);var b=this,c=!1;$.each(a,function(a,d){var e=b.getValue().indexOf(d[b.valueField]);e>-1&&(b._selection.splice(e,1),c=!0)}),c===!0&&(this._renderSelection(this.resultAsString),$(this).trigger("selectionchange",[this,this.getSelectedItems()]),this.expanded&&this._processSuggestions())},render:function(a){this.isRendered()===!1&&(this.renderTo=a,this._doRender())},setValue:function(a){var b=$.isArray(a)?a:[a],c=this,d=[];$.each(this.combobox.children(),function(a,e){var f=$(e).data("json");b.indexOf(f[c.valueField])>-1&&d.push(f)}),d.length>0&&this.addToSelection(d)},_doRender:function(){if(this.isRendered()===!1){switch($(this).trigger("beforerender",[this]),this.container=$("<div/>",{id:"ms-ctn-"+$('div[id^="ms-ctn"]').length,"class":"ms-ctn "+this.cls+(this.disabled===!0?" ms-ctn-disabled":"")+(this.editable===!0?"":" ms-ctn-readonly"),style:"width: "+this.width+"px;"}),this.container.focus($.proxy(this._onContainerFocus,this)),this.container.blur($.proxy(this._onContainerBlur,this)),this.container.keydown($.proxy(this._onHandleKeyDown,this)),this.container.keyup($.proxy(this._onHandleKeyUp,this)),this.input=$("<input/>",{id:"ms-input-"+$('input[id^="ms-input"]').length,type:"text","class":this.emptyTextCls+(this.editable===!0?"":" ms-input-readonly"),value:this.emptyText,readonly:!this.editable,style:"width: "+(this.width-(this.hideTrigger?16:38))+"px;"}),this.input.focus($.proxy(this._onInputFocus,this)),this.hideTrigger===!1&&(this.trigger=$("<div/>",{id:"ms-trigger-"+$('div[id^="ms-trigger"]').length,"class":"ms-trigger",html:'<div class="ms-trigger-ico"></div>'}),this.trigger.click($.proxy(this._onTriggerClick,this)),this.container.append(this.trigger)),this.combobox=$("<div/>",{id:"ms-res-ctn-"+$('div[id^="ms-res-ctn"]').length,"class":"ms-res-ctn",style:"width: "+this.width+"px; height: "+this.maxDropHeight+"px;"}),this.selectionContainer=$("<div/>",{id:"ms-sel-ctn-"+$('div[id^="ms-sel-ctn"]').length,"class":"ms-sel-ctn"}),this.selectionContainer.click($.proxy(this._onContainerFocus,this)),"inner"===this.selectionPosition?this.selectionContainer.append(this.input):this.container.append(this.input),$(this.renderTo).replaceWith(this.container),this.selectionPosition){case"bottom":this.selectionContainer.insertAfter(this.container),this.selectionStacked===!0&&(this.selectionContainer.width(this.container.width()),this.selectionContainer.addClass("ms-stacked"));break;case"right":this.selectionContainer.insertAfter(this.container),this.container.css("float","left");break;default:this.container.append(this.selectionContainer)}this._rendered=!0,this._processSuggestions(),null!==this.value&&(this.setValue(this.value),this.resultAsString===!0&&this._renderSelection(!0)),$(this).trigger("afterrender",[this]);var a=this;$("body").click(function(b){0===a.container.has(b.target).length&&a._onContainerBlur()})}},_onContainerFocus:function(){this.input.focus()},_onInputFocus:function(){this.isDisabled()===!1&&(this.container.addClass("ms-ctn-bootstrap-focus"),this.input.val()===this.emptyText&&(this.input.removeClass(this.emptyTextCls),this.input.val("")),(this.expandOnFocus===!0&&0===this.input.val().length||this.input.val().length>this.minChars)&&this.expand(),this.resultAsString===!0&&this._renderSelection(),$(this).trigger("focus",[this]))},_onContainerBlur:function(){this.input.is(":focus")||this._forceBlur()},_forceBlur:function(){this.container.removeClass("ms-ctn-bootstrap-focus"),""===this.input.val()&&(this.input.addClass(this.emptyTextCls),this.input.val(this.emptyText)),this.collapse(),this.resultAsString===!0&&this._renderSelection(!0),$(this).trigger("blur",[this])},_onHandleKeyDown:function(a){var b=this.combobox.find(".ms-res-item-active:first"),c=this.input.val()!==this.emptyText?this.input.val():"";if($(this).trigger("onkeydown",[this,a]),9===a.keyCode&&(this.useTabKey===!1||this.useTabKey===!0&&0===b.length&&0===this.input.val().length))return this._forceBlur(),void 0;switch(a.keyCode){case 8:0===c.length&&this.getSelectedItems().length>0&&"inner"===this.selectionPosition&&(this._selection.pop(),this._renderSelection(),$(this).trigger("selectionchange",[this,this.getSelectedItems()]),this.input.focus(),a.preventDefault());break;case 9:a.preventDefault();break;case 188:a.preventDefault();break;case 40:a.preventDefault(),this._moveSelectedRow("down");break;case 38:a.preventDefault(),this._moveSelectedRow("up")}},_onHandleKeyUp:function(a){var d,b=this.input.val()!==this.emptyText?this.input.val():"",c=this.input.val().length>0&&this.input.val()!==this.emptyText,e={},f=this;if($(this).trigger("onkeyup",[this,a]),!(9===a.keyCode&&this.useTabKey===!1||a.keyCode>13&&32>a.keyCode))switch(a.keyCode){case 40:case 38:a.preventDefault();break;case 13:case 9:case 188:if(188!==a.keyCode||this.useCommaKey===!0){if(a.preventDefault(),this.expanded&&(d=this.combobox.find(".ms-res-item-active:first"),d.length>0))return d.click(),void 0;c===!0&&this.allowFreeEntries===!0&&(e[this.displayField]=e[this.valueField]=b,this.addToSelection(e),this.collapse(),f.input.focus());break}default:this.expanded===!0?this._processSuggestions():b.length>=this.minChars&&this.expanded===!1&&this.expand()}},_onTriggerClick:function(){this.isDisabled()===!1&&($(this).trigger("ontriggerclick",[this]),this.expanded===!0?this.collapse():(this.input.focus(),this.expand()))},_processSuggestions:function(){if(null!==this.data)if("string"==typeof this.data&&0>this.data.indexOf(",")){$(this).trigger("onbeforeload",[this]);var a=this;$.ajax({type:"post",url:this.data,data:JSON.stringify({query:this.input.val()}),success:function(b){var c=JSON.parse(b);$(this).trigger("onload",[a,c]),a._displaySuggestions(a._sortAndTrim(c))},error:function(){throw"Could not reach server"}})}else"string"==typeof this.data&&this.data.indexOf(",")>-1?this._displaySuggestions(this._sortAndTrim(this._getEntriesFromStringArray(this.data.split(",")))):this.data.length>0&&"string"==typeof this.data[0]?this._displaySuggestions(this._sortAndTrim(this._getEntriesFromStringArray(this.data))):this._displaySuggestions(this._sortAndTrim(this.data))},_getEntriesFromStringArray:function(a){var b=[],c=this;return $.each(a,function(a,d){var e={};e[c.displayField]=e[c.valueField]=d.trim(),b.push(e)}),b},_sortAndTrim:function(a){var b=this,c=this.input.val()!==this.emptyText?this.input.val():"",d=[],e=[],f=this.getValue();return c.length>0?$.each(a,function(a,e){var f=e[b.displayField];(b.matchCase===!0&&f.indexOf(c)>-1||b.matchCase===!1&&f.toLowerCase().indexOf(c.toLowerCase())>-1)&&d.push(e)}):d=a,$.each(d,function(a,c){-1===f.indexOf(c[b.valueField])&&e.push(c)}),null!==this.sortOrder&&e.sort(function(a,c){return a[b.sortOrder]<c[b.sortOrder]?"asc"===b.sortDir?-1:1:a[b.sortOrder]>c[b.sortOrder]?"asc"===b.sortDir?1:-1:0}),this.maxResults!==!1&&this.maxResults>0&&(e=e.slice(0,this.maxResults)),e},_displaySuggestions:function(a){this.combobox.empty();var b=this,c=0;$.each(a,function(a,d){var e=$("<div/>",{"class":"ms-res-item "+(1===a%2&&b.useZebraStyle===!0?"ms-res-odd":""),html:b.highlight===!0?b._highlightSuggestion(d[b.displayField]):d[b.displayField]}).data("json",d);e.click($.proxy(b._onComboItemSelected,b)),e.mouseover($.proxy(b._onComboItemMouseOver,b)),b.combobox.append(e),c+=29}),this.combobox.height()>c||this.maxDropHeight>c?this.combobox.height(c):c>=this.combobox.height()&&c>this.maxDropHeight&&this.combobox.height(this.maxDropHeight),1===a.length&&this.preselectSingleSuggestion===!0&&this.combobox.children().addClass("ms-res-item-active")},_highlightSuggestion:function(a){var b=this.input.val()!==this.emptyText?this.input.val():"";return 0===b.length?a:a=this.matchCase===!0?a.replace(RegExp("("+b+")","g"),"<em>$1</em>"):a.replace(RegExp("("+b+")","gi"),"<em>$1</em>")},_onComboItemMouseOver:function(a){this.combobox.children().removeClass("ms-res-item-active"),$(a.currentTarget).addClass("ms-res-item-active")},_onComboItemSelected:function(a){var b=this;this.addToSelection($(a.currentTarget).data("json")),$(a.currentTarget).removeClass("ms-res-item-active"),this.collapse(),b.input.focus()},_renderSelection:function(a){var b=this,c=0,d=0;"inner"===this.selectionPosition&&this.input.detach(),this.selectionContainer.empty(),$.each(this._selection,function(c,d){var e,f;a===!0?e=$("<div/>",{"class":"ms-sel-item ms-sel-text "+b.selectionCls,html:d[b.displayField]+(c===b._selection.length-1?"":",")}).data("json",d):(e=$("<div/>",{"class":"ms-sel-item "+b.selectionCls,html:d[b.displayField]}).data("json",d),f=$("<span/>",{"class":"ms-close-btn"}).data("json",d).appendTo(e),f.click($.proxy(b._onRemoveFromSelection,b))),b.selectionContainer.append(e)}),"inner"===this.selectionPosition&&(this.selectionContainer.append(this.input),this.input.width(0),(this.editable===!0||0===this._selection.length)&&(d=this.input.offset().left-this.selectionContainer.offset().left,c=this.container.width()-d-32-(this.hideTrigger===!0?0:36),this.input.width(100>c?100:c)),this.container.height(this.selectionContainer.height()))},_onRemoveFromSelection:function(a){this.removeFromSelection($(a.currentTarget).data("json"))},_moveSelectedRow:function(a){this.expanded||this.expand();var b,c,d,e;b=this.combobox.find(".ms-res-item"),c="down"===a?b.eq(0):b.filter(":last"),d=this.combobox.find(".ms-res-item-active:first"),d.length>0&&("down"===a?(c=d.next(),0===c.length&&(c=b.eq(0)),e=this.combobox.scrollTop(),this.combobox.scrollTop(0),c[0].offsetTop+c.height()>this.combobox.height()&&this.combobox.scrollTop(e+29)):(c=d.prev(),0===c.length&&(c=b.filter(":last"),this.combobox.scrollTop(29*b.length)),c[0].offsetTop<this.combobox.scrollTop()&&this.combobox.scrollTop(this.combobox.scrollTop()-29))),b.removeClass("ms-res-item-active"),c.addClass("ms-res-item-active")}});